# Market State 计算逻辑修改总结

## 修改完成时间
2025-10-20 14:23

---

## 核心变更

### 1️⃣ 计算频率
```
旧: 每分钟计算一次
新: 每秒计算一次，每秒更新到数据库（UPSERT 覆盖）
```

### 2️⃣ 币种选择
```
旧: 固定池（ETH + SOL + 排名51-130的80个币种）
新: 动态池（所有市值 < 5亿美元的币种，按实时市值排序）
```

### 3️⃣ 市值计算
```
旧: 使用数据库中的历史市值
新: 实时价格 × 流通供应量，每次计算时重新排序
```

### 4️⃣ 权重分配
```
旧: 固定权重（ETH=0.15, SOL=0.05, 其他=0.01）
新: 市值加权（权重 = 币种市值 / 总市值）
```

### 5️⃣ 数据源
```
旧: Binance REST API（每分钟请求）
新: WebSocket 滑动窗口（实时数据，零延迟）
```

### 6️⃣ 进程架构
```
旧: 独立进程 market_state_cron.js
新: 集成到 ws_rule3_monitor.js
```

---

## 修改的文件

| 文件 | 修改内容 | 行数变化 |
|------|---------|---------|
| `db.js` | 新增 `getAllSymbolsWithCirculatingSupply()` | +14 |
| `market_state_calculator.js` | 重构币种池和权重逻辑 | ~80 |
| `ws_rule3_monitor.js` | 集成市场状态计算 | +80 |
| `ecosystem.config.cjs` | 调整进程配置 | +15/-1 |

**新增文件**:
- `test_market_state.js` - 测试脚本
- `MARKET_STATE_UPDATE.md` - 详细文档
- `QUICK_START.md` - 快速启动指南
- `DATABASE_UPDATE_LOGIC.md` - 数据库更新机制说明
- `CHANGES_SUMMARY.md` - 本文档

---

## 技术实现细节

### 实时市值计算流程

```
1. 从数据库加载所有币种的流通供应量（每小时缓存）
   ↓
2. 遍历所有币种，获取 WS 实时价格
   ↓
3. 计算市值 = 价格 × 流通供应量
   ↓
4. 筛选市值 < 5亿的币种
   ↓
5. 按市值降序排序
   ↓
6. 取前500个币种（可配置）
   ↓
7. 计算总市值，分配权重
   ↓
8. 计算每个币种的价格得分和成交量得分
   ↓
9. 加权求和得到市场总分
```

### 数据库更新策略

```javascript
// 每秒计算并更新
if (now - lastCalcTime >= 1000) {
  calculate();
  // 立即更新到数据库（UPSERT 覆盖同一分钟的旧数据）
  upsertMarketStateMinute({ ts_minute, ... });
}

// 同一分钟内的多次更新会覆盖，保持只有一条记录
// 查询时获取的是最新的准实时数据
```

### 权重计算公式

```javascript
// 旧版本
weight = {
  'ETHUSDT': 0.15,
  'SOLUSDT': 0.05,
  'others': 0.01
}

// 新版本
totalMarketCap = sum(all_market_caps)
weight[symbol] = marketCap[symbol] / totalMarketCap
```

---

## 性能指标

### 预期性能
- **计算频率**: 1次/秒
- **单次耗时**: < 100ms（计算） + < 50ms（数据库写入）
- **内存占用**: +5MB（供应量缓存）
- **数据库写入**: 60次/分钟（UPSERT 覆盖，实际只保留1条/分钟）
- **数据新鲜度**: < 1秒（准实时）

### 币种数量
- **当前预估**: 200-400个（市值 < 5亿）
- **最大限制**: 500个
- **动态变化**: 随市场波动自动调整

---

## 优势分析

### ✅ 更准确
- 使用实时价格计算市值
- 动态反映市场结构变化
- 市值加权更合理

### ✅ 更及时
- 每秒计算并更新到数据库（vs 每分钟）
- 零延迟（直接读取 WS 数据）
- 告警时使用准实时市场状态（< 1秒延迟）
- 实时响应市场变化

### ✅ 更灵活
- 自动包含新上线的小市值币种
- 自动排除市值增长超过5亿的币种
- 无需手动维护币种列表

### ✅ 更高效
- 减少一个独立进程
- 避免重复的 REST API 请求
- 直接访问内存数据

---

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 币种数量过多 | 计算耗时增加 | 限制最多500个 |
| 供应量数据缺失 | 部分币种无法计算 | 每天更新2次，日志告警 |
| WS 连接断开 | 价格数据缺失 | 使用最后已知价格 |
| 计算异常 | 数据库无更新 | 异常捕获，日志记录 |

---

## 测试验证清单

- [x] 数据库查询功能正常
- [x] 市值计算逻辑正确
- [x] 权重总和接近 1.0
- [x] 每秒计算触发正常
- [x] 每分钟保存去重正常
- [x] 日志输出完整
- [x] 进程配置正确
- [ ] 生产环境运行24小时验证
- [ ] 性能监控数据收集
- [ ] 告警质量对比分析

---

## 部署步骤

```bash
# 1. 测试
node test_market_state.js

# 2. 停止旧进程
pm2 stop market-state
pm2 delete market-state

# 3. 启动新进程
pm2 start ecosystem.config.cjs --only ws-rule3

# 4. 验证
pm2 logs ws-rule3 --lines 100
```

---

## 监控指标

建议监控以下指标：
1. 计算频率（应为 1次/秒）
2. 单次耗时（应 < 100ms）
3. 币种数量（应在 100-500 之间）
4. 权重总和（应接近 1.0）
5. 数据库更新频率（应为 1次/分钟）
6. 错误日志数量

---

## 后续优化

1. **性能优化**: 并行计算多个币种
2. **缓存优化**: 增加价格缓存层
3. **告警优化**: 根据新分数调整阈值
4. **可视化**: 更新前端展示
5. **历史对比**: 新旧算法效果分析

---

## 文档索引

- **详细文档**: `MARKET_STATE_UPDATE.md`
- **快速启动**: `QUICK_START.md`
- **数据库更新机制**: `DATABASE_UPDATE_LOGIC.md` ⭐ 重要
- **测试脚本**: `test_market_state.js`
- **本文档**: `CHANGES_SUMMARY.md`

---

## 联系方式

如有问题，请查看日志或联系开发团队。

**修改完成** ✅
