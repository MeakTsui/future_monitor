<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market State - TradingView Lightweight Charts</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls label {
      margin-right: 10px;
      font-weight: 500;
    }
    .controls select, .controls button {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-right: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .controls button {
      background: #2196F3;
      color: white;
      border: none;
    }
    .controls button:hover {
      background: #1976D2;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    .stat-card .value.positive {
      color: #4CAF50;
    }
    .stat-card .value.negative {
      color: #F44336;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .chart-wrapper {
      position: relative;
      height: 400px;
      margin-top: 10px;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>📊 Market State Monitor - TradingView Charts</h1>
    
    <div class="controls">
      <label>时间范围:</label>
      <select id="timeRange">
        <option value="1">最近1小时</option>
        <option value="6">最近6小时</option>
        <option value="24" selected>最近24小时</option>
        <option value="72">最近3天</option>
        <option value="168">最近7天</option>
      </select>
      
      <label>分辨率:</label>
      <select id="resolution">
        <option value="1">1分钟</option>
        <option value="5" selected>5分钟</option>
        <option value="15">15分钟</option>
        <option value="60">1小时</option>
      </select>
      
      <button onclick="loadData()">🔄 刷新数据</button>
      <button onclick="toggleAutoRefresh()">⏱️ <span id="autoRefreshText">启用自动刷新</span></button>
    </div>

    <div id="error" class="error"></div>

    <div class="stats">
      <div class="stat-card">
        <h3>当前价格得分</h3>
        <div class="value" id="currentPrice">--</div>
      </div>
      <div class="stat-card">
        <h3>当前成交量得分</h3>
        <div class="value" id="currentVolume">--</div>
      </div>
      <div class="stat-card">
        <h3>数据点数量</h3>
        <div class="value" id="dataPoints">--</div>
      </div>
      <div class="stat-card">
        <h3>最后更新</h3>
        <div class="value" style="font-size: 16px;" id="lastUpdate">--</div>
      </div>
    </div>

    <div class="chart-container">
      <h2 style="margin-bottom: 15px; font-size: 18px;">
        Market Price Score (-100 ~ 100)
        <span style="font-size: 12px; color: #666; font-weight: normal; margin-left: 10px;">
          📈 上涨趋势 | 📉 下跌趋势
        </span>
      </h2>
      <div id="priceChart" class="chart-wrapper"></div>
    </div>

    <div class="chart-container">
      <h2 style="margin-bottom: 15px; font-size: 18px;">
        Market Volume Score (0 ~ 100)
        <span style="font-size: 12px; color: #666; font-weight: normal; margin-left: 10px;">
          🔥 成交活跃度
        </span>
      </h2>
      <div id="volumeChart" class="chart-wrapper"></div>
    </div>
  </div>

  <script>
    // 使用相对路径，自动适配当前域名和端口
    const SERVER_URL = window.location.origin;
    let priceChart = null;
    let priceSeries = null;
    let volumeChart = null;
    let volumeSeries = null;
    let autoRefreshInterval = null;

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = '❌ ' + message;
      errorEl.style.display = 'block';
      console.error('Error:', message);
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    // 初始化 TradingView 图表
    function initCharts() {
      try {
        console.log('初始化 TradingView 图表...');
        
        if (typeof LightweightCharts === 'undefined') {
          throw new Error('TradingView Lightweight Charts 未加载');
        }

        // Price Chart
        const priceContainer = document.getElementById('priceChart');
        priceChart = LightweightCharts.createChart(priceContainer, {
          width: priceContainer.clientWidth,
          height: 400,
          layout: {
            background: { color: '#ffffff' },
            textColor: '#333',
          },
          grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          rightPriceScale: {
            borderColor: '#ddd',
          },
          timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        priceSeries = priceChart.addAreaSeries({
          topColor: 'rgba(33, 150, 243, 0.4)',
          bottomColor: 'rgba(33, 150, 243, 0.0)',
          lineColor: 'rgba(33, 150, 243, 1)',
          lineWidth: 2,
        });

        // 添加零线参考
        priceChart.addLineSeries({
          color: '#999',
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Dashed,
          priceLineVisible: false,
          lastValueVisible: false,
        }).setData([
          { time: Math.floor(Date.now() / 1000) - 86400, value: 0 },
          { time: Math.floor(Date.now() / 1000), value: 0 }
        ]);

        // Volume Chart
        const volumeContainer = document.getElementById('volumeChart');
        volumeChart = LightweightCharts.createChart(volumeContainer, {
          width: volumeContainer.clientWidth,
          height: 400,
          layout: {
            background: { color: '#ffffff' },
            textColor: '#333',
          },
          grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          rightPriceScale: {
            borderColor: '#ddd',
          },
          timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        volumeSeries = volumeChart.addAreaSeries({
          topColor: 'rgba(76, 175, 80, 0.4)',
          bottomColor: 'rgba(76, 175, 80, 0.0)',
          lineColor: 'rgba(76, 175, 80, 1)',
          lineWidth: 2,
        });

        // 响应式调整
        window.addEventListener('resize', () => {
          priceChart.applyOptions({ width: priceContainer.clientWidth });
          volumeChart.applyOptions({ width: volumeContainer.clientWidth });
        });

        console.log('✓ TradingView 图表初始化成功');
        return true;
      } catch (err) {
        console.error('✗ 图表初始化失败:', err);
        showError('图表初始化失败: ' + err.message);
        return false;
      }
    }

    // 加载数据
    async function loadData() {
      try {
        hideError();
        console.log('加载数据...');
        
        const timeRange = parseInt(document.getElementById('timeRange').value);
        const resolution = document.getElementById('resolution').value;
        
        const to = Math.floor(Date.now() / 1000);
        const from = to - (timeRange * 3600);

        const priceUrl = `${SERVER_URL}/tradingview/history?symbol=MARKET_PRICE&resolution=${resolution}&from=${from}&to=${to}`;
        const volumeUrl = `${SERVER_URL}/tradingview/history?symbol=MARKET_VOLUME&resolution=${resolution}&from=${from}&to=${to}`;

        const [priceRes, volumeRes] = await Promise.all([
          fetch(priceUrl),
          fetch(volumeUrl)
        ]);

        const priceData = await priceRes.json();
        const volumeData = await volumeRes.json();

        console.log('Price data:', priceData.s, priceData.t?.length || 0, 'points');
        console.log('Volume data:', volumeData.s, volumeData.t?.length || 0, 'points');

        if (priceData.s === 'ok' && volumeData.s === 'ok') {
          updateCharts(priceData, volumeData);
          updateStats(priceData, volumeData);
        } else if (priceData.s === 'no_data') {
          showError('暂无数据。请确保 market_state_cron.js 正在运行。');
        } else {
          showError('数据加载失败: ' + (priceData.errmsg || '未知错误'));
        }
      } catch (err) {
        console.error('加载数据失败:', err);
        showError('加载数据失败: ' + err.message);
      }
    }

    // 更新图表
    function updateCharts(priceData, volumeData) {
      if (!priceSeries || !volumeSeries) {
        console.warn('图表未初始化');
        return;
      }

      try {
        // 转换为 TradingView 格式
        const priceChartData = priceData.t.map((time, i) => ({
          time: time,
          value: priceData.c[i]
        }));

        const volumeChartData = volumeData.t.map((time, i) => ({
          time: time,
          value: volumeData.c[i]
        }));

        // 更新数据
        priceSeries.setData(priceChartData);
        volumeSeries.setData(volumeChartData);

        // 自动调整视图
        priceChart.timeScale().fitContent();
        volumeChart.timeScale().fitContent();

        console.log('✓ 图表更新成功');
      } catch (err) {
        console.error('更新图表失败:', err);
        showError('更新图表失败: ' + err.message);
      }
    }

    // 更新统计信息
    function updateStats(priceData, volumeData) {
      const currentPrice = priceData.c[priceData.c.length - 1];
      const currentVolume = volumeData.c[volumeData.c.length - 1];
      
      const priceEl = document.getElementById('currentPrice');
      priceEl.textContent = currentPrice.toFixed(2);
      priceEl.className = 'value ' + (currentPrice > 0 ? 'positive' : currentPrice < 0 ? 'negative' : '');
      
      document.getElementById('currentVolume').textContent = currentVolume.toFixed(2);
      document.getElementById('dataPoints').textContent = priceData.t.length;
      
      const lastTime = new Date(priceData.t[priceData.t.length - 1] * 1000);
      document.getElementById('lastUpdate').textContent = lastTime.toLocaleString('zh-CN');
    }

    // 自动刷新
    function toggleAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        document.getElementById('autoRefreshText').textContent = '启用自动刷新';
      } else {
        autoRefreshInterval = setInterval(loadData, 60000); // 每分钟刷新
        document.getElementById('autoRefreshText').textContent = '停止自动刷新';
        loadData();
      }
    }

    // 页面加载完成后初始化
    window.addEventListener('load', () => {
      console.log('页面加载完成');
      
      setTimeout(() => {
        if (initCharts()) {
          loadData();
        }
      }, 100);
    });
  </script>
</body>
</html>
