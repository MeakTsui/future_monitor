<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Market State - TradingView Lightweight Charts</title>
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      color: #333;
      margin-bottom: 20px;
      font-size: 24px;
    }
    .controls {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .controls label {
      margin-right: 10px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }
    .controls input[type="checkbox"] {
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
    .controls select, .controls button {
      padding: 8px 16px;
      border-radius: 6px;
      border: 1px solid #ddd;
      margin-right: 10px;
      font-size: 14px;
      cursor: pointer;
    }
    .controls button {
      background: #2196F3;
      color: white;
      border: none;
    }
    .controls button:hover {
      background: #1976D2;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .stat-card h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    .stat-card .value {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    .stat-card .value.positive {
      color: #4CAF50;
    }
    .stat-card .value.negative {
      color: #F44336;
    }
    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .chart-wrapper {
      width: 100%;
      height: 400px;
      position: relative;
    }
    .chart-tooltip {
      position: absolute;
      display: none;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      border-radius: 6px;
      font-size: 13px;
      pointer-events: none;
      z-index: 1000;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
      white-space: nowrap;
    }
    .chart-tooltip .tooltip-time {
      font-weight: 600;
      margin-bottom: 4px;
      color: #4fc3f7;
    }
    .chart-tooltip .tooltip-value {
      margin: 2px 0;
    }
    .chart-tooltip .tooltip-label {
      color: #aaa;
      margin-right: 6px;
    }
    .error {
      background: #ffebee;
      color: #c62828;
      padding: 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      display: none;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ“Š Market State Monitor - TradingView Charts</h1>
    
    <div class="controls">
      <label>æ—¶é—´èŒƒå›´:</label>
      <select id="timeRange">
        <option value="1">æœ€è¿‘1å°æ—¶</option>
        <option value="6">æœ€è¿‘6å°æ—¶</option>
        <option value="24" selected>æœ€è¿‘24å°æ—¶</option>
        <option value="72">æœ€è¿‘3å¤©</option>
        <option value="168">æœ€è¿‘7å¤©</option>
      </select>
      
      <label>åˆ†è¾¨ç‡:</label>
      <select id="resolution">
        <option value="1">1åˆ†é’Ÿ</option>
        <option value="5" selected>5åˆ†é’Ÿ</option>
        <option value="15">15åˆ†é’Ÿ</option>
        <option value="60">1å°æ—¶</option>
      </select>
      
      <label>å‡çº¿:</label>
      <select id="ma1" onchange="loadData()">
        <option value="">ä¸æ˜¾ç¤º</option>
        <option value="5" selected>MA5 (5åˆ†é’Ÿ)</option>
        <option value="10">MA10 (10åˆ†é’Ÿ)</option>
        <option value="15">MA15 (15åˆ†é’Ÿ)</option>
        <option value="30">MA30 (30åˆ†é’Ÿ)</option>
        <option value="60">MA60 (1å°æ—¶)</option>
      </select>
      
      <select id="ma2" onchange="loadData()">
        <option value="">ä¸æ˜¾ç¤º</option>
        <option value="5">MA5 (5åˆ†é’Ÿ)</option>
        <option value="10">MA10 (10åˆ†é’Ÿ)</option>
        <option value="15">MA15 (15åˆ†é’Ÿ)</option>
        <option value="30">MA30 (30åˆ†é’Ÿ)</option>
        <option value="60" selected>MA60 (1å°æ—¶)</option>
      </select>
      
      <button onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
      <button onclick="toggleAutoRefresh()">â±ï¸ <span id="autoRefreshText">å¯ç”¨è‡ªåŠ¨åˆ·æ–°</span></button>
    </div>

    <div id="error" class="error"></div>

    <div class="stats">
      <div class="stat-card">
        <h3>å½“å‰ä»·æ ¼å¾—åˆ†</h3>
        <div class="value" id="currentPrice">--</div>
      </div>
      <div class="stat-card">
        <h3>å½“å‰æˆäº¤é‡å¾—åˆ†</h3>
        <div class="value" id="currentVolume">--</div>
      </div>
      <div class="stat-card">
        <h3>å½“å‰ Volume Score 2</h3>
        <div class="value" id="currentVolumeScore2">--</div>
      </div>
      <div class="stat-card">
        <h3>æ•°æ®ç‚¹æ•°é‡</h3>
        <div class="value" id="dataPoints">--</div>
      </div>
      <div class="stat-card">
        <h3>æœ€åæ›´æ–°</h3>
        <div class="value" style="font-size: 16px;" id="lastUpdate">--</div>
      </div>
    </div>

    <div class="chart-container">
      <h2 style="margin-bottom: 15px; font-size: 18px;">
        Market Price Score (-100 ~ 100)
        <span style="font-size: 12px; color: #666; font-weight: normal; margin-left: 10px;">
          ğŸ“ˆ ä¸Šæ¶¨è¶‹åŠ¿ | ğŸ“‰ ä¸‹è·Œè¶‹åŠ¿
        </span>
      </h2>
      <div id="priceChart" class="chart-wrapper">
        <div id="priceTooltip" class="chart-tooltip"></div>
      </div>
    </div>

    <div class="chart-container">
      <h2 style="margin-bottom: 15px; font-size: 18px;">
        Market Volume Score (0 ~ 100)
        <span style="font-size: 12px; color: #666; font-weight: normal; margin-left: 10px;">
          ğŸ”¥ æˆäº¤æ´»è·ƒåº¦
        </span>
      </h2>
      <div id="volumeChart" class="chart-wrapper">
        <div id="volumeTooltip" class="chart-tooltip"></div>
      </div>
    </div>

    <div class="chart-container">
      <h2 style="margin-bottom: 15px; font-size: 18px;">
        Market Volume Score 2 (MA Ratio)
        <span style="font-size: 12px; color: #666; font-weight: normal; margin-left: 10px;">
          ğŸ“Š æˆäº¤é‡å‡çº¿æ¯”ç‡ (MA1 / MA120)
        </span>
      </h2>
      <div id="volumeScore2Chart" class="chart-wrapper">
        <div id="volumeScore2Tooltip" class="chart-tooltip"></div>
      </div>
    </div>
  </div>

  <script>
    // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…å½“å‰åŸŸåå’Œç«¯å£
    const SERVER_URL = window.location.origin;
    const TIMEZONE_OFFSET = 8 * 3600; // ä¸œ8åŒºåç§»ï¼ˆç§’ï¼‰
    let priceChart = null;
    let priceSeries = null;
    let priceMASeries = {}; // å­˜å‚¨å‡çº¿ç³»åˆ— {window: series}
    let volumeChart = null;
    let volumeSeries = null;
    let volumeMASeries = {}; // å­˜å‚¨å‡çº¿ç³»åˆ— {window: series}
    let volumeScore2Chart = null;
    let volumeScore2Series = null;
    let autoRefreshInterval = null;

    function showError(message) {
      const errorEl = document.getElementById('error');
      errorEl.textContent = 'âŒ ' + message;
      errorEl.style.display = 'block';
      console.error('Error:', message);
    }

    function hideError() {
      document.getElementById('error').style.display = 'none';
    }

    // è®¾ç½® Tooltip
    function setupTooltip(chart, tooltipId, seriesName, mainSeries) {
      const tooltip = document.getElementById(tooltipId);
      const container = tooltip.parentElement;
      
      chart.subscribeCrosshairMove((param) => {
        if (
          param.point === undefined ||
          !param.time ||
          param.point.x < 0 ||
          param.point.x > container.clientWidth ||
          param.point.y < 0 ||
          param.point.y > container.clientHeight
        ) {
          tooltip.style.display = 'none';
          return;
        }

        const data = param.seriesData.get(mainSeries);
        if (!data) {
          tooltip.style.display = 'none';
          return;
        }

        // æ ¼å¼åŒ–æ—¶é—´
        const date = new Date(param.time * 1000);
        const timeStr = date.toLocaleString('zh-CN', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit',
          hour12: false
        });

        // æ ¼å¼åŒ–æ•°å€¼
        const value = data.value !== undefined ? data.value.toFixed(4) : 'N/A';

        // æ„å»º tooltip å†…å®¹
        let html = `<div class="tooltip-time">${timeStr}</div>`;
        html += `<div class="tooltip-value"><span class="tooltip-label">${seriesName}:</span><strong>${value}</strong></div>`;

        // å¦‚æœæœ‰å‡çº¿æ•°æ®ï¼Œä¹Ÿæ˜¾ç¤º
        const maSeriesKeys = Object.keys(seriesName === 'Price Score' ? priceMASeries : (seriesName === 'Volume Score' ? volumeMASeries : {}));
        maSeriesKeys.forEach(window => {
          const maSeries = seriesName === 'Price Score' ? priceMASeries[window] : volumeMASeries[window];
          const maData = param.seriesData.get(maSeries);
          if (maData && maData.value !== undefined) {
            html += `<div class="tooltip-value"><span class="tooltip-label">MA${window}:</span><strong>${maData.value.toFixed(4)}</strong></div>`;
          }
        });

        tooltip.innerHTML = html;
        tooltip.style.display = 'block';

        // å®šä½ tooltip
        const tooltipWidth = tooltip.offsetWidth;
        const tooltipHeight = tooltip.offsetHeight;
        let left = param.point.x + 15;
        let top = param.point.y - tooltipHeight / 2;

        // é˜²æ­¢ tooltip è¶…å‡ºå³è¾¹ç•Œ
        if (left + tooltipWidth > container.clientWidth) {
          left = param.point.x - tooltipWidth - 15;
        }

        // é˜²æ­¢ tooltip è¶…å‡ºä¸Šä¸‹è¾¹ç•Œ
        if (top < 0) top = 0;
        if (top + tooltipHeight > container.clientHeight) {
          top = container.clientHeight - tooltipHeight;
        }

        tooltip.style.left = left + 'px';
        tooltip.style.top = top + 'px';
      });
    }

    // åˆå§‹åŒ– TradingView å›¾è¡¨
    function initCharts() {
      try {
        console.log('åˆå§‹åŒ– TradingView å›¾è¡¨...');
        
        if (typeof LightweightCharts === 'undefined') {
          throw new Error('TradingView Lightweight Charts æœªåŠ è½½');
        }

        // Price Chart
        const priceContainer = document.getElementById('priceChart');
        priceChart = LightweightCharts.createChart(priceContainer, {
          width: priceContainer.clientWidth,
          height: 400,
          layout: {
            background: { color: '#ffffff' },
            textColor: '#333',
          },
          grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          rightPriceScale: {
            borderColor: '#ddd',
          },
          timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        priceSeries = priceChart.addAreaSeries({
          topColor: 'rgba(33, 150, 243, 0.4)',
          bottomColor: 'rgba(33, 150, 243, 0.0)',
          lineColor: 'rgba(33, 150, 243, 1)',
          lineWidth: 2,
        });

        // æ·»åŠ é›¶çº¿å‚è€ƒ
        priceChart.addLineSeries({
          color: '#999',
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Dashed,
          priceLineVisible: false,
          lastValueVisible: false,
        }).setData([
          { time: Math.floor(Date.now() / 1000) - 86400 + TIMEZONE_OFFSET, value: 0 },
          { time: Math.floor(Date.now() / 1000) + TIMEZONE_OFFSET, value: 0 }
        ]);

        // Volume Chart
        const volumeContainer = document.getElementById('volumeChart');
        volumeChart = LightweightCharts.createChart(volumeContainer, {
          width: volumeContainer.clientWidth,
          height: 400,
          layout: {
            background: { color: '#ffffff' },
            textColor: '#333',
          },
          grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          rightPriceScale: {
            borderColor: '#ddd',
          },
          timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        volumeSeries = volumeChart.addAreaSeries({
          topColor: 'rgba(76, 175, 80, 0.4)',
          bottomColor: 'rgba(76, 175, 80, 0.0)',
          lineColor: 'rgba(76, 175, 80, 1)',
          lineWidth: 2,
        });

        // Volume Score 2 Chart
        const volumeScore2Container = document.getElementById('volumeScore2Chart');
        volumeScore2Chart = LightweightCharts.createChart(volumeScore2Container, {
          width: volumeScore2Container.clientWidth,
          height: 400,
          layout: {
            background: { color: '#ffffff' },
            textColor: '#333',
          },
          grid: {
            vertLines: { color: '#f0f0f0' },
            horzLines: { color: '#f0f0f0' },
          },
          crosshair: {
            mode: LightweightCharts.CrosshairMode.Normal,
          },
          rightPriceScale: {
            borderColor: '#ddd',
          },
          timeScale: {
            borderColor: '#ddd',
            timeVisible: true,
            secondsVisible: false,
          },
        });

        volumeScore2Series = volumeScore2Chart.addLineSeries({
          color: '#FF9800',
          lineWidth: 2,
          title: 'Volume Score 2',
        });

        // æ·»åŠ å‚è€ƒçº¿ (1.0)
        volumeScore2Chart.addLineSeries({
          color: '#999',
          lineWidth: 1,
          lineStyle: LightweightCharts.LineStyle.Dashed,
          priceLineVisible: false,
          lastValueVisible: false,
        }).setData([
          { time: Math.floor(Date.now() / 1000) - 86400 + TIMEZONE_OFFSET, value: 1.0 },
          { time: Math.floor(Date.now() / 1000) + TIMEZONE_OFFSET, value: 1.0 }
        ]);

        // æ·»åŠ é¼ æ ‡æ‚¬åœäº‹ä»¶ç›‘å¬
        setupTooltip(priceChart, 'priceTooltip', 'Price Score', priceSeries);
        setupTooltip(volumeChart, 'volumeTooltip', 'Volume Score', volumeSeries);
        setupTooltip(volumeScore2Chart, 'volumeScore2Tooltip', 'Volume Score 2', volumeScore2Series);

        // å“åº”å¼è°ƒæ•´
        window.addEventListener('resize', () => {
          priceChart.applyOptions({ width: priceContainer.clientWidth });
          volumeChart.applyOptions({ width: volumeContainer.clientWidth });
          volumeScore2Chart.applyOptions({ width: volumeScore2Container.clientWidth });
        });

        console.log('âœ“ TradingView å›¾è¡¨åˆå§‹åŒ–æˆåŠŸ');
        return true;
      } catch (err) {
        console.error('âœ— å›¾è¡¨åˆå§‹åŒ–å¤±è´¥:', err);
        showError('å›¾è¡¨åˆå§‹åŒ–å¤±è´¥: ' + err.message);
        return false;
      }
    }

    // åŠ è½½æ•°æ®
    async function loadData() {
      try {
        hideError();
        console.log('åŠ è½½æ•°æ®...');
        
        const timeRange = parseInt(document.getElementById('timeRange').value);
        const resolution = document.getElementById('resolution').value;
        const ma1Window = document.getElementById('ma1').value;
        const ma2Window = document.getElementById('ma2').value;
        
        const to = Math.floor(Date.now() / 1000);
        const from = to - (timeRange * 3600);
        const fromMs = from * 1000;
        const toMs = to * 1000;

        // æ„å»ºè¯·æ±‚
        const requests = [
          fetch(`${SERVER_URL}/tradingview/history?symbol=MARKET_PRICE&resolution=${resolution}&from=${from}&to=${to}`),
          fetch(`${SERVER_URL}/tradingview/history?symbol=MARKET_VOLUME&resolution=${resolution}&from=${from}&to=${to}`),
          fetch(`${SERVER_URL}/market/volume_score/history?from=${fromMs}&to=${toMs}`)
        ];
        
        // æ·»åŠ å‡çº¿è¯·æ±‚
        if (ma1Window) {
          requests.push(fetch(`${SERVER_URL}/market/state/ma?window=${ma1Window}&from=${fromMs}&to=${toMs}`));
        }
        if (ma2Window && ma2Window !== ma1Window) {
          requests.push(fetch(`${SERVER_URL}/market/state/ma?window=${ma2Window}&from=${fromMs}&to=${toMs}`));
        }

        const responses = await Promise.all(requests);
        const priceData = await responses[0].json();
        const volumeData = await responses[1].json();
        const volumeScore2Data = await responses[2].json();
        
        let ma1Data = null, ma2Data = null;
        let idx = 3;
        if (ma1Window) {
          ma1Data = await responses[idx++].json();
        }
        if (ma2Window && ma2Window !== ma1Window) {
          ma2Data = await responses[idx++].json();
        } else if (ma2Window === ma1Window) {
          ma2Data = ma1Data; // ç›¸åŒçª—å£ï¼Œå¤ç”¨æ•°æ®
        }

        console.log('Price data:', priceData.s, priceData.t?.length || 0, 'points');
        console.log('Volume data:', volumeData.s, volumeData.t?.length || 0, 'points');
        console.log('Volume Score 2 data:', volumeScore2Data.data?.length || 0, 'points');
        if (ma1Data) console.log('MA1 data:', ma1Window, 'min,', ma1Data.data?.length || 0, 'points');
        if (ma2Data) console.log('MA2 data:', ma2Window, 'min,', ma2Data.data?.length || 0, 'points');

        if (priceData.s === 'ok' && volumeData.s === 'ok') {
          updateCharts(priceData, volumeData, volumeScore2Data.data, {
            ma1: ma1Data?.data,
            ma1Window,
            ma2: ma2Data?.data,
            ma2Window
          });
          updateStats(priceData, volumeData, volumeScore2Data.data);
        } else if (priceData.s === 'no_data') {
          showError('æš‚æ— æ•°æ®ã€‚è¯·ç¡®ä¿ market_state_cron.js å’Œ volume_score_calculator.js æ­£åœ¨è¿è¡Œã€‚');
        } else {
          showError('æ•°æ®åŠ è½½å¤±è´¥: ' + (priceData.errmsg || 'æœªçŸ¥é”™è¯¯'));
        }
      } catch (err) {
        console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
        showError('åŠ è½½æ•°æ®å¤±è´¥: ' + err.message);
      }
    }

    // æ›´æ–°å›¾è¡¨
    function updateCharts(priceData, volumeData, volumeScore2Data, maData = {}) {
      if (!priceSeries || !volumeSeries || !volumeScore2Series) {
        console.warn('å›¾è¡¨æœªåˆå§‹åŒ–');
        return;
      }

      try {
        // è½¬æ¢ä¸º TradingView æ ¼å¼ï¼ˆåŠ ä¸Šä¸œ8åŒºåç§»ï¼‰
        const priceChartData = priceData.t.map((time, i) => ({
          time: time + TIMEZONE_OFFSET,
          value: priceData.c[i]
        }));

        const volumeChartData = volumeData.t.map((time, i) => ({
          time: time + TIMEZONE_OFFSET,
          value: volumeData.c[i]
        }));

        // Volume Score 2 æ•°æ®
        const volumeScore2ChartData = (volumeScore2Data || []).map(item => ({
          time: Math.floor(item.ts_minute / 1000) + TIMEZONE_OFFSET,
          value: item.market_volume_score_2
        }));

        // æ›´æ–°ä¸»æ•°æ®ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        priceSeries.setData(priceChartData);
        volumeSeries.setData(volumeChartData);

        // æ›´æ–° Volume Score 2ï¼ˆå§‹ç»ˆæ˜¾ç¤ºï¼‰
        volumeScore2Series.setData(volumeScore2ChartData);

        // æ¸…ç†æ‰€æœ‰æ—§çš„å‡çº¿ç³»åˆ—
        clearAllMASeries(priceChart, priceMASeries);
        clearAllMASeries(volumeChart, volumeMASeries);

        // æ›´æ–°å‡çº¿ï¼ˆåˆ›å»ºæ–°çš„ï¼‰
        if (maData.ma1Window && maData.ma1) {
          updateMASeries(priceChart, priceMASeries, maData.ma1, maData.ma1Window, '#FF6B6B', 'Price');
          updateMASeries(volumeChart, volumeMASeries, maData.ma1, maData.ma1Window, '#FF6B6B', 'Volume');
        }
        if (maData.ma2Window && maData.ma2) {
          updateMASeries(priceChart, priceMASeries, maData.ma2, maData.ma2Window, '#4ECDC4', 'Price');
          updateMASeries(volumeChart, volumeMASeries, maData.ma2, maData.ma2Window, '#4ECDC4', 'Volume');
        }

        // è‡ªåŠ¨è°ƒæ•´è§†å›¾
        priceChart.timeScale().fitContent();
        volumeChart.timeScale().fitContent();
        volumeScore2Chart.timeScale().fitContent();

        console.log('âœ“ å›¾è¡¨æ›´æ–°æˆåŠŸ', { volumeScore2Points: volumeScore2ChartData.length });
      } catch (err) {
        console.error('æ›´æ–°å›¾è¡¨å¤±è´¥:', err);
        showError('æ›´æ–°å›¾è¡¨å¤±è´¥: ' + err.message);
      }
    }

    // æ¸…ç†æ‰€æœ‰å‡çº¿ç³»åˆ—
    function clearAllMASeries(chart, seriesMap) {
      for (const window in seriesMap) {
        if (seriesMap[window]) {
          try {
            chart.removeSeries(seriesMap[window]);
          } catch (e) {
            console.warn('ç§»é™¤å‡çº¿ç³»åˆ—å¤±è´¥:', window, e);
          }
          delete seriesMap[window];
        }
      }
    }

    // æ›´æ–°å‡çº¿ç³»åˆ—
    function updateMASeries(chart, seriesMap, maData, window, color, type) {
      if (!window || !maData || maData.length === 0) {
        return;
      }

      // åˆ›å»ºæ–°ç³»åˆ—
      seriesMap[window] = chart.addLineSeries({
        color: color,
        lineWidth: 2,
        title: `MA${window}`,
        priceLineVisible: false,
        lastValueVisible: true,
      });

      // è½¬æ¢æ•°æ®ï¼ˆåŠ ä¸Šä¸œ8åŒºåç§»ï¼‰
      const field = type === 'Price' ? 'price_score' : 'volume_score';
      const chartData = maData.map(item => ({
        time: Math.floor(item.ts_minute / 1000) + TIMEZONE_OFFSET,
        value: item[field]
      }));

      seriesMap[window].setData(chartData);
    }

    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
    function updateStats(priceData, volumeData, volumeScore2Data) {
      const currentPrice = priceData.c[priceData.c.length - 1];
      const currentVolume = volumeData.c[volumeData.c.length - 1];
      
      const priceEl = document.getElementById('currentPrice');
      priceEl.textContent = currentPrice.toFixed(2);
      priceEl.className = 'value ' + (currentPrice > 0 ? 'positive' : currentPrice < 0 ? 'negative' : '');
      
      document.getElementById('currentVolume').textContent = currentVolume.toFixed(2);
      
      // Volume Score 2
      if (volumeScore2Data && volumeScore2Data.length > 0) {
        const currentVS2 = volumeScore2Data[volumeScore2Data.length - 1].market_volume_score_2;
        const vs2El = document.getElementById('currentVolumeScore2');
        vs2El.textContent = currentVS2.toFixed(4);
        vs2El.className = 'value ' + (currentVS2 > 1 ? 'positive' : currentVS2 < 1 ? 'negative' : '');
      } else {
        document.getElementById('currentVolumeScore2').textContent = '--';
      }
      
      document.getElementById('dataPoints').textContent = priceData.t.length;
      
      // è½¬æ¢ä¸ºä¸œ8åŒºæ—¶é—´æ˜¾ç¤º
      const lastTime = new Date((priceData.t[priceData.t.length - 1] + TIMEZONE_OFFSET) * 1000);
      document.getElementById('lastUpdate').textContent = lastTime.toLocaleString('zh-CN');
    }

    // è‡ªåŠ¨åˆ·æ–°
    function toggleAutoRefresh() {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        document.getElementById('autoRefreshText').textContent = 'å¯ç”¨è‡ªåŠ¨åˆ·æ–°';
      } else {
        autoRefreshInterval = setInterval(loadData, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°
        document.getElementById('autoRefreshText').textContent = 'åœæ­¢è‡ªåŠ¨åˆ·æ–°';
        loadData();
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    window.addEventListener('load', () => {
      console.log('é¡µé¢åŠ è½½å®Œæˆ');
      
      setTimeout(() => {
        if (initCharts()) {
          loadData();
        }
      }, 100);
    });
  </script>
</body>
</html>
