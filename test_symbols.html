<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>测试交易对数据</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #0d1117;
      color: #c9d1d9;
    }
    pre {
      background: #161b22;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
    }
    button {
      padding: 10px 20px;
      background: #238636;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin: 10px 5px;
    }
    button:hover {
      background: #2ea043;
    }
    .error {
      color: #f85149;
    }
    .success {
      color: #3fb950;
    }
  </style>
</head>
<body>
  <h1>交易对数据测试</h1>
  
  <button onclick="testSymbols()">测试获取交易对列表</button>
  <button onclick="testAlerts()">测试获取告警统计</button>
  <button onclick="testBinance()">测试 Binance API</button>
  
  <h2>结果：</h2>
  <pre id="output">点击按钮开始测试...</pre>

  <script>
    const output = document.getElementById('output');

    function log(msg, type = 'info') {
      const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : '');
      output.innerHTML += `<div class="${className}">${msg}</div>`;
    }

    function clear() {
      output.innerHTML = '';
    }

    async function testSymbols() {
      clear();
      log('测试 /api/symbols 接口...');
      
      try {
        const response = await fetch('/api/symbols');
        const data = await response.json();
        
        log(`✓ 成功获取 ${data.symbols.length} 个交易对`, 'success');
        log('\n前 20 个交易对:');
        data.symbols.slice(0, 20).forEach((symbol, i) => {
          log(`  ${i + 1}. ${symbol}`);
        });
        
        // 检查格式
        const withoutUSDT = data.symbols.filter(s => !s.endsWith('USDT'));
        if (withoutUSDT.length > 0) {
          log(`\n⚠ 警告: 发现 ${withoutUSDT.length} 个不以 USDT 结尾的交易对:`, 'error');
          withoutUSDT.slice(0, 10).forEach(s => log(`  - ${s}`));
        } else {
          log('\n✓ 所有交易对格式正确（都以 USDT 结尾）', 'success');
        }
        
      } catch (error) {
        log(`✗ 错误: ${error.message}`, 'error');
      }
    }

    async function testAlerts() {
      clear();
      log('测试 /api/alerts/stats 接口...');
      
      try {
        const response = await fetch('/api/alerts/stats');
        const data = await response.json();
        
        const symbols = Object.keys(data.bySymbol);
        log(`✓ 成功获取 ${symbols.length} 个有告警的交易对`, 'success');
        
        if (symbols.length > 0) {
          log('\n前 10 个有告警的交易对:');
          symbols.slice(0, 10).forEach(symbol => {
            const stats = data.bySymbol[symbol];
            log(`  ${symbol}: 总计=${stats.total}, 默认=${stats.type1}, 档位=${stats.type2}`);
          });
        } else {
          log('\n⚠ 没有找到任何告警数据', 'error');
        }
        
      } catch (error) {
        log(`✗ 错误: ${error.message}`, 'error');
      }
    }

    async function testBinance() {
      clear();
      log('测试 Binance API...');
      
      const testSymbols = ['BTCUSDT', '1000FLOKIUSDT', 'ETHUSDT', 'SOLUSDT'];
      
      for (const symbol of testSymbols) {
        try {
          log(`\n测试 ${symbol}...`);
          const response = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1m&limit=10`);
          
          if (response.ok) {
            const data = await response.json();
            log(`  ✓ 成功获取 ${data.length} 根 K 线`, 'success');
          } else {
            const error = await response.json();
            log(`  ✗ 失败: ${error.msg}`, 'error');
          }
        } catch (error) {
          log(`  ✗ 错误: ${error.message}`, 'error');
        }
      }
    }
  </script>
</body>
</html>
